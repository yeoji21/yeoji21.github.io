---
title: "클린 코더스 강의 정리 - 3장"
author: "yeoji21"
date: 2021-11-09
categories: [Backend, oop]
tags: [java, oop, programming]
---

## 들어가면서

- 해당 포스트는 [최범균님의 클린 코더스 강의](https://www.youtube.com/watch?v=60lLSe1phks)를 정리한 내용입니다. 
- 강의 자료는 [깃 허브](https://github.com/msbaek/clean-coders-2013)에서 보실 수 있습니다.


## 클린 코더스 강의 3. Function

### 1. 원칙
- 한 가지 일만 해야 한다.
- 함수의 크기는 과장 보태서 4줄짜리여야 한다.
    - 따라서 indentation, while, nested if 등은 없어야
- 잘 지어진 서술적인 이름을 갖는 많은/작은 함수들로 유지해야 한다.

2. The First Rule of Functions
- 더 이상 작아질 수 없을만큼 작아야 한다.
- 큰 함수를 보면 클래스로 추출할 생각을 해야 한다. Extract Method Object
- 클래스는 일련의 변수들이 동작하는 기능의 집합이다. 
- extreact method 할 때는 서로 다른 점을 변수로 추출하고 그 변수들은 새로운 methof의 파라미터로 전달한다. 

### extreact method 예제 - FitnessExample

```java
public class FitnessExample {
    public String testableHtml(PageData pageData, boolean includeSuiteSetup) throws Exception {
        WikiPage wikiPage = pageData.getWikiPage();
        StringBuffer buffer = new StringBuffer();

        if (pageData.hasAttribute("Test")) {
            if (includeSuiteSetup) {
                WikiPage suiteSetup = PageCrawlerImpl.getInheritedPage(SuiteResponder.SUITE_SETUP_NAME, wikiPage);
                if (suiteSetup != null) {
                    WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteSetup);
                    String pagePathName = PathParser.render(pagePath);
                    buffer.append("!include -setup .").append(pagePathName).append("\n");
                }
            }
            WikiPage setup = PageCrawlerImpl.getInheritedPage("SetUp", wikiPage);
            if (setup != null) {
                WikiPagePath setupPath = wikiPage.getPageCrawler().getFullPath(setup);
                String setupPathName = PathParser.render(setupPath);
                buffer.append("!include -setup .").append(setupPathName).append("\n");
            }
        }

        buffer.append(pageData.getContent());
        if (pageData.hasAttribute("Test")) {
            WikiPage teardown = PageCrawlerImpl.getInheritedPage("TearDown", wikiPage);
            if (teardown != null) {
                WikiPagePath tearDownPath = wikiPage.getPageCrawler().getFullPath(teardown);
                String tearDownPathName = PathParser.render(tearDownPath);
                buffer.append("!include -teardown .").append(tearDownPathName).append("\n");
            }
            if (includeSuiteSetup) {
                WikiPage suiteTeardown = PageCrawlerImpl.getInheritedPage(SuiteResponder.SUITE_TEARDOWN_NAME, wikiPage);
                if (suiteTeardown != null) {
                    WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteTeardown);
                    String pagePathName = PathParser.render(pagePath);
                    buffer.append("!include -teardown .").append(pagePathName).append("\n");
                }
            }
        }

        pageData.setContent(buffer.toString());
        return pageData.getHtml();
    }
}
```

extact method to object
```java
public class FitnessExample {
    public String testableHtml(PageData pageData, boolean includeSuiteSetup) throws Exception{
        return new TestableHtmlBuilder(pageData, includeSuiteSetup).invoke();
    }
    
    private class TestableHtmlBuilder {
        private PageData pageData;
        private boolean includeSuiteSetup;

        public TestableHtmlBuilder(PageData pageData, boolean includeSuiteSetup) {
            this.pageData = pageData;
            this.includeSuiteSetup = includeSuiteSetup;
        }

        public String invoke() throws Exception {
            WikiPage wikiPage = pageData.getWikiPage();
            StringBuffer buffer = new StringBuffer();
                        ...
```

메소드의 여러 곳에서 사용되는 `wikiPage`와 `buffer`를 field variable로 올리고 생성자를 통해서 초기화시킨다.

이를 통해 나중에 내부에서 다른 메소드를 추출할 때마다 매번 파라미터로 받지 않을 수 있게된다.
```java
private class TestableHtmlBuilder {
    private PageData pageData;
    private boolean includeSuiteSetup;
    private WikiPage wikiPage;
    private StringBuffer buffer;

    public TestableHtmlBuilder(PageData pageData, boolean includeSuiteSetup) {
        this.pageData = pageData;
        this.includeSuiteSetup = includeSuiteSetup;
        wikiPage = pageData.getWikiPage();
        buffer = new StringBuffer();
    }

    public String invoke() throws Exception {
        if (pageData.hasAttribute("Test")) {
            ...
```

자주 반복되는 아래 코드 세 줄을 메소드로 뽑기 위해서 먼저 메소드마다 다른 `append()` 내부 string을 변수로 추출한다. 
```java
WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteSetup);
String pagePathName = PathParser.render(pagePath);
buffer.append("!include -setup .").append(pagePathName).append("\n");
```

```java
String setup = "setup";
WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteSetup);
String pagePathName = PathParser.render(pagePath);
buffer.append("!include -" + setup + " .").append(pagePathName).append("\n");
```

includePage() 메소드로 추출
```java
public String invoke() throws Exception {
    if (pageData.hasAttribute("Test")) {
        if (includeSuiteSetup) {
            WikiPage suiteSetup = PageCrawlerImpl.getInheritedPage(SuiteResponder.SUITE_SETUP_NAME, wikiPage);
            if (suiteSetup != null) {
                String setup1 = "setup";
                includePage(suiteSetup, setup1);
            }
        }
        WikiPage setup = PageCrawlerImpl.getInheritedPage("SetUp", wikiPage);
        if (setup != null) {
            String setup1 = "setup";
            includePage(setup, setup1);
        }
    }

    buffer.append(pageData.getContent());
    if (pageData.hasAttribute("Test")) {
        WikiPage teardown = PageCrawlerImpl.getInheritedPage("TearDown", wikiPage);
        if (teardown != null) {
            String teardown1 = "teardown";
            includePage(teardown, teardown1);
        }
        if (includeSuiteSetup) {
            WikiPage suiteTeardown = PageCrawlerImpl.getInheritedPage(SuiteResponder.SUITE_TEARDOWN_NAME, wikiPage);
            if (suiteTeardown != null) {
                String teardown1 = "teardown";
                includePage(suiteTeardown, teardown1);
            }
        }
    }
    ...
private void includePage(WikiPage suiteSetup, String setup1) {
    WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteSetup);
    String pagePathName = PathParser.render(pagePath);
    buffer.append("!include -" + setup1 + " .").append(pagePathName).append("\n");
}
```

이제 아래 부분들을 공통화시켜서 메소드로 뽑아야 한다.
```java
WikiPage suiteSetup = PageCrawlerImpl.getInheritedPage(SuiteResponder.SUITE_SETUP_NAME, wikiPage);
if (suiteSetup != null) {
    String setup1 = "setup";
    includePage(suiteSetup, setup1);
}
```

위에서와 마찬가지로 각 코드마다 다른 `getInheritedPage()`의 파라미터값을 변수로 뽑는다.

그 후 메소드로 뽑기 위해 앞에서 변수로 뽑았던 `setup1`, `teardown1`등을 위로 올려준다.
```java
if (pageData.hasAttribute("Test")) {
    if (includeSuiteSetup) {
        Object suiteSetupName = SuiteResponder.SUITE_SETUP_NAME;
        String setup1 = "setup";
        WikiPage suiteSetup = PageCrawlerImpl.getInheritedPage(suiteSetupName, wikiPage);
        if (suiteSetup != null) {
            includePage(suiteSetup, setup1);
        }
    }
    String setUp = "SetUp";
    String setup1 = "setup";
    WikiPage setup = PageCrawlerImpl.getInheritedPage(setUp, wikiPage);
    if (setup != null) {
        includePage(setup, setup1);
    }
}
```

그 후 includeInherited() 메소드로 추출한다.
```java
if (pageData.hasAttribute("Test")) {
    if (includeSuiteSetup) {
        Object suiteSetupName = SuiteResponder.SUITE_SETUP_NAME;
        String setup1 = "setup";
        includeInherited(suiteSetupName, setup1);
    }
    String setUp = "SetUp";
    String setup1 = "setup";
    includeInherited(setUp, setup1);
}

buffer.append(pageData.getContent());
if (pageData.hasAttribute("Test")) {
    String tearDown = "TearDown";
    String teardown1 = "teardown";
    includeInherited(tearDown, teardown1);
    if (includeSuiteSetup) {
        Object suiteTeardownName = SuiteResponder.SUITE_TEARDOWN_NAME;
        String teardown2 = "teardown";
        includeInherited(suiteTeardownName, teardown2);
    }
}
```

앞서 서로 다른 부분을 메소드로 뽑기 위해서 변수로 선언했지만 이제 필요없기때문에 변수를 파라미터로 인라인시킨다.

이 과정속에서 if문 내에 실행할 문장이 하나가 된다면 괄호를 지워주도록 하자.
```java
if (pageData.hasAttribute("Test")) {
    if (includeSuiteSetup)
        includeInherited(SuiteResponder.SUITE_SETUP_NAME, "setup");
    includeInherited("SetUp", "setup");
}

buffer.append(pageData.getContent());
if (pageData.hasAttribute("Test")) {
    includeInherited("TearDown", "teardown");
    if (includeSuiteSetup) 
        includeInherited(SuiteResponder.SUITE_TEARDOWN_NAME, "teardown");
}
```

여기서 가독성을 더 높이기 위해 setup을 위한 메소드와 teardown을 위한 메소드를 추출한다.
```java
public String invoke() throws Exception {
    if (pageData.hasAttribute("Test"))
        includeSetups();
    buffer.append(pageData.getContent());
    if (pageData.hasAttribute("Test"))
        includeTeardowns();
    pageData.setContent(buffer.toString());
    return pageData.getHtml();
}
```

중복된 if문을 제거하고 하나의 if문 내부로 밀어넣자.
```java
public String invoke() throws Exception {
    if (pageData.hasAttribute("Test")) {
        includeSetups();
        buffer.append(pageData.getContent());
        includeTeardowns();
    }
    pageData.setContent(buffer.toString());
    return pageData.getHtml();
}
```

if문 내부의 조건도 가독성을 높이기 위해 메소드로 추출한다.
```java
public String invoke() throws Exception {
    if (isTestPage()) {
        includeSetups();
        buffer.append(pageData.getContent());
        includeTeardowns();
    }
    pageData.setContent(buffer.toString());
    return pageData.getHtml();
}
```
메소드를 읽어보면 

만약 테스트 페이지이면 setup을 include하고 버퍼에 페이지의 content를 넣고 teardown을 include한 뒤,

버퍼에 있는 데이터를 페이지 데이터에 입력한 뒤, 페이지 데이터를 html로 변경한다는 것을 알 수 있다. 

이렇게 리팩토링 후 `invoke()`를 읽기 훨씬 수월해졌다.


<br>

이제 추출한 클래스명과 invoke()의 이름을 의미있게 변경하는 등 나머지 리펙토링 작업을 수행한 최종 코드는 아래와 같다.
```java
public class FitnessExample {
    public String testableHtml(PageData pageData, boolean includeSuiteSetup) throws Exception {
        return new SetUpTearDownSurrounder(pageData, includeSuiteSetup).surround();
    }

    private class SetUpTearDownSurrounder {
        private PageData pageData;
        private boolean includeSuiteSetup;
        private WikiPage wikiPage;
        private String content;

        public SetUpTearDownSurrounder(PageData pageData, boolean includeSuiteSetup) {
            this.pageData = pageData;
            this.includeSuiteSetup = includeSuiteSetup;
            wikiPage = pageData.getWikiPage();
            content = new String();
        }

        public String surround() throws Exception {
            if (ifTestPage())
                surroundPageWithSetUpsAndTearDowns();
            return pageData.getHtml();
        }

        private void surroundPageWithSetUpsAndTearDowns() throws Exception {
            content = includeSetups();
            content += pageData.getContent();
            content += includeTearDowns();
            pageData.setContent(content);
        }

        private boolean ifTestPage() throws Exception {
            return pageData.hasAttribute("Test");
        }

        private String includeTearDowns() throws Exception {
            String tearDowns = includeInherited("TearDown", "teardown");
            if (includeSuiteSetup)
                tearDowns += includeInherited(SuiteResponder.SUITE_TEARDOWN_NAME, "teardown");
            return tearDowns;
        }

        private String includeSetups() throws Exception {
            String setUps = "";
            if (includeSuiteSetup)
                setUps += includeInherited(SuiteResponder.SUITE_SETUP_NAME, "setup");
            setUps += includeInherited("SetUp", "setup");
            return setUps;
        }

        private String includeInherited(String pageName, String mode) throws Exception {
            WikiPage suiteSetup = PageCrawlerImpl.getInheritedPage(pageName, wikiPage);
            if (suiteSetup != null)
                return includePage(suiteSetup, mode);
            return "";
        }

        private String includePage(WikiPage suiteSetup, String mode) throws Exception {
            WikiPagePath pagePath = wikiPage.getPageCrawler().getFullPath(suiteSetup);
            String pagePathName = PathParser.render(pagePath);
            return String.format("!include -%s .%s\n", mode, pagePathName);
        }
    }
}
```

### 4. 개선
- 읽기 쉬워지고
- 이해하기 쉬워지고
- 함수가 자신의 의도를 잘 전달

### 5. 개선의 원인
- Small
    - 함수의 첫 번째 규칙. 함수는 작아질 수 있는 한 최대한 작아야 함
- 블록이 적어야 함
    - if, else, while 문장 등의 내부 블록은 한 줄이어야 함
    - 따라서 괄호가 없고 함수 호출일 것
- Indenting이 적어야 함
    - 함수는 중첩 구조를 갖을 만큼 크면 안됨
    - 들여쓰기는 한 두단계 정도만

### 6. functions should do one thing
리펙토링 전의 메소드는 하나 이상의 일을 하고 있던 것에 비해 리펙토링 후의 메소드는 하나의 단순한 일만 실행한다. 

그런데 메소드를 살펴보면 여러 메소드를 실행하는 등 한 가지 일만 수행하는 것 같지는 않아보인다. 메소드가 한 가지 일만 실행한다는 것은 무엇을 의미할까? 

메소드가 수행하는 모든 일의 추상화 수준이 같고, 메소드의 각 스텝들이 메소드 이름이 갖는 추상화 수준보다 한 단계 낮은 것으로만 이루어졌다면 메소드는 한 가지 일만 한다고 할 수 있다. 따라서 원래 코드는 추상화 수준이 다른 많은 단계들을 포함하므로 한 가지 이상의 일을 한다는 것이 명확하다. 

하지만 메소드가 한 가지 일만 하도록 최종적으로 줄이는 것은 매우 어렵다. 이를 어떤 기능을 to 부정사구문으로 표현하여 이 기능을 수행하기 위해서는 어떤 과정이 필요한지 생각해본다면 같은 추상화 수준의 계층을 그려볼 수 있을 것이다. 

### 7. Where do classes do to hide?
큰 메소드는 실제로 클래스가 숨어있는 곳이다. 

큰 메소드는 들여쓰기가 존재하고 변수들을 사용해서 통신하는 기능들의 집합이다. 그렇다면 이 메소드는 항상 하나 이상의 클래스로 분리할 수 있을 것이다.